# KigaliDrive - Complete Project Documentation
## Premium Car Rental Platform with Role-Based Access Control (RBAC)
## For Google NotebookLM Presentation

---

# TABLE OF CONTENTS
1. Executive Summary
2. System Architecture
3. User Roles & Authentication Flow
4. Database Schema & Design
5. API Endpoints Reference
6. Business Logic & Workflows
7. Email Notification System
8. Security Features
9. Test Users & Demo Data
10. Docker Deployment

---

# 1. EXECUTIVE SUMMARY

## Project Overview
KigaliDrive is a comprehensive full-stack car rental platform serving the Rwandan market. It enables car owners to list their vehicles for rent, clients to book cars, and administrators to manage the entire platform.

## Key Features
- **Multi-Role System**: Admin, Manager, Car Owner, Client
- **Email Verification**: 6-digit code verification for new user registration
- **Real-Time Notifications**: In-app + Email notifications
- **Payment Processing**: 5% platform commission model
- **Car Management**: Listing, approval workflow, availability tracking
- **Booking System**: Date-based reservations with conflict detection
- **Analytics Dashboard**: Revenue, bookings, user statistics

## Tech Stack
| Layer | Technology |
|-------|------------|
| Backend | .NET 8 Web API |
| Database | SQLite with Entity Framework Core |
| Authentication | JWT Bearer Tokens + BCrypt |
| Frontend | React 18 + Redux Toolkit |
| Build Tool | Vite |
| Email | Gmail SMTP |

---

# 2. SYSTEM ARCHITECTURE

## Project Structure
```
FinalExam3/
â”œâ”€â”€ Controllers/          # API endpoints
â”‚   â”œâ”€â”€ AuthController.cs
â”‚   â”œâ”€â”€ UsersController.cs
â”‚   â”œâ”€â”€ CarsController.cs
â”‚   â”œâ”€â”€ BookingsController.cs
â”‚   â”œâ”€â”€ PaymentsController.cs
â”‚   â”œâ”€â”€ ReportsController.cs
â”‚   â””â”€â”€ NotificationsController.cs
â”œâ”€â”€ Services/             # Business logic
â”‚   â”œâ”€â”€ AuthService.cs
â”‚   â”œâ”€â”€ UserService.cs
â”‚   â”œâ”€â”€ CarService.cs
â”‚   â”œâ”€â”€ BookingService.cs
â”‚   â”œâ”€â”€ PaymentService.cs
â”‚   â”œâ”€â”€ EmailService.cs
â”‚   â”œâ”€â”€ NotificationService.cs
â”‚   â””â”€â”€ ReportService.cs
â”œâ”€â”€ Models/               # Database entities
â”‚   â”œâ”€â”€ User.cs
â”‚   â”œâ”€â”€ Car.cs
â”‚   â”œâ”€â”€ Booking.cs
â”‚   â”œâ”€â”€ Payment.cs
â”‚   â”œâ”€â”€ Notification.cs
â”‚   â”œâ”€â”€ PasswordResetToken.cs
â”‚   â””â”€â”€ LoginVerificationToken.cs
â”œâ”€â”€ DTOs/                 # Data transfer objects
â”œâ”€â”€ Data/                 # DbContext
â””â”€â”€ Migrations/           # EF Core migrations

kigalidrive-frontend/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ components/       # Reusable UI components
â”‚   â”œâ”€â”€ pages/            # Route pages
â”‚   â”œâ”€â”€ store/            # Redux state
â”‚   â”œâ”€â”€ services/         # API client
â”‚   â””â”€â”€ App.jsx           # Routes
```

---

# 3. USER ROLES & AUTHENTICATION FLOW

## User Roles

| Role | Code | Description | Registration |
|------|------|-------------|--------------|
| Admin | 1 | Full system access, manage all users | Created by Admin |
| Manager | 2 | Approve cars/owners, view reports | Created by Admin |
| Car Owner | 3 | List cars, manage bookings, confirm payments | Self-register |
| Client | 4 | Browse & book cars | Self-register |

## Authentication Flows

### Client/Car Owner Registration (New!):
1. User fills registration form
2. **6-digit verification code sent to email**
3. User enters code on verification modal
4. Account verified â†’ User logged in automatically
5. JWT token stored in localStorage

### Client/Car Owner Login:
1. User enters email + password
2. JWT token returned immediately
3. Redirect to dashboard

### Admin/Manager Login:
1. User enters email + password
2. JWT token returned immediately
3. Redirect to dashboard

### Google OAuth Login:
1. User clicks "Sign in with Google"
2. Selects role (Client or Car Owner)
3. JWT token returned immediately
4. If new user, CEO welcome email sent

## Permission Matrix

| Feature | Admin | Manager | Car Owner | Client |
|---------|:-----:|:-------:|:---------:|:------:|
| Self-Register | âŒ | âŒ | âœ… | âœ… |
| Create Admin/Manager | âœ… | âŒ | âŒ | âŒ |
| View All Users | âœ… | âŒ | âŒ | âŒ |
| Approve Cars | âœ… | âœ… | âŒ | âŒ |
| Force Delete Users | âœ… | âŒ | âŒ | âŒ |
| List Cars | âŒ | âŒ | âœ… | âŒ |
| Book Cars | âŒ | âŒ | âŒ | âœ… |
| Confirm Payments | âŒ | âŒ | âœ… (Own) | âŒ |
| View Reports | âœ… | âœ… | âŒ | âŒ |

---

# 4. DATABASE SCHEMA & DESIGN

## Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚1     Nâ”‚    Car      â”‚1     Nâ”‚   Booking   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â—„â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚â—„â”€â”€â”€â”€â”€â”€â”¤â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Id (PK)     â”‚       â”‚ Id (PK)     â”‚       â”‚ Id (PK)     â”‚
â”‚ FirstName   â”‚       â”‚ Make        â”‚       â”‚ UserId (FK) â”‚
â”‚ LastName    â”‚       â”‚ Model       â”‚       â”‚ CarId (FK)  â”‚
â”‚ Email (UK)  â”‚       â”‚ Year        â”‚       â”‚ StartDate   â”‚
â”‚ PasswordHashâ”‚       â”‚ LicensePlateâ”‚       â”‚ EndDate     â”‚
â”‚ PhoneNumber â”‚       â”‚ PricePerDay â”‚       â”‚ TotalPrice  â”‚
â”‚ Role        â”‚       â”‚ OwnerId (FK)â”‚       â”‚ Status      â”‚
â”‚ IsActive    â”‚       â”‚ Status      â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
â”‚ IsEmailVer. â”‚       â”‚ IsAvailable â”‚              â”‚1
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
       â”‚1                                          â”‚
       â”‚N                                    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”                              â”‚  Payment  â”‚
â”‚Notification â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                              â”‚ Id (PK)   â”‚
â”‚ Id (PK)     â”‚                              â”‚BookingId  â”‚
â”‚ UserId (FK) â”‚                              â”‚ Amount    â”‚
â”‚ Title       â”‚                              â”‚ Status    â”‚
â”‚ Message     â”‚                              â”‚ PaidAt    â”‚
â”‚ IsRead      â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚LoginVerificationTokenâ”‚ (NEW - for 2FA)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Id (PK)              â”‚
â”‚ UserId (FK)          â”‚
â”‚ Code (6-digit)       â”‚
â”‚ ExpiresAt            â”‚
â”‚ IsUsed               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Enums

```csharp
public enum UserRole { Admin=1, Manager=2, CarOwner=3, Client=4 }
public enum ApprovalStatus { Pending=1, Approved=2, Rejected=3 }
public enum BookingStatus { Pending=1, Confirmed=2, InProgress=3, Completed=4, Cancelled=5 }
public enum PaymentStatus { Pending=1, Paid=2, Failed=3 }
public enum CarStatus { PendingApproval=1, Available=2, Rented=3, Maintenance=4, Unavailable=5 }
```

## Key Models

### User
- Stores authentication data, role, approval status
- Phone number required for Car Owners (enforced when listing cars)
- IsEmailVerified tracks if user completed verification

### Car
- Linked to Owner (User with CarOwner role)
- Status workflow: PendingApproval â†’ Approved by Manager â†’ Available
- Unique constraint on LicensePlate

### Booking
- Links Client to Car with date range
- TotalPrice calculated as (EndDate - StartDate).Days * PricePerDay
- Status progression: Pending â†’ Confirmed â†’ InProgress â†’ Completed

### Payment
- One-to-one with Booking
- Platform takes 5% commission
- Car Owner confirms payment â†’ triggers notifications

### LoginVerificationToken
- Stores 6-digit verification codes
- 5-minute expiry
- Used for registration verification

---

# 5. API ENDPOINTS REFERENCE

## Authentication (/api/auth)
| Method | Endpoint | Description | Auth |
|--------|----------|-------------|------|
| POST | /register | Register + send 6-digit code | No |
| POST | /verify-code | Verify registration code | No |
| POST | /resend-code | Resend verification code | No |
| POST | /login | Login with credentials | No |
| POST | /google | Google OAuth login | No |
| POST | /forgot-password | Request password reset | No |
| POST | /reset-password | Reset with token | No |
| POST | /change-password | Change password | Yes |
| GET | /me | Get current user | Yes |

## Users (/api/users)
| Method | Endpoint | Description | Roles |
|--------|----------|-------------|-------|
| GET | / | List all users (paginated) | Admin |
| GET | /pending-approvals | Get pending users | Admin, Manager |
| POST | /{id}/approve | Approve/Reject user | Admin, Manager |
| POST | /internal | Create Admin/Manager | Admin |
| POST | /{id}/deactivate | Deactivate user | Admin |
| POST | /{id}/reactivate | Reactivate user | Admin |
| DELETE | /{id} | Permanently delete user | Admin |

## Cars (/api/cars)
| Method | Endpoint | Description | Roles |
|--------|----------|-------------|-------|
| GET | / | List all cars | Public |
| GET | /available | Available cars only | Public |
| GET | /pending | Pending approval | Admin, Manager |
| GET | /my-cars | Owner's cars | CarOwner |
| POST | / | Create car (requires phone) | CarOwner |
| POST | /{id}/approve | Approve/Reject car | Admin, Manager |

## Bookings (/api/bookings)
| Method | Endpoint | Description | Roles |
|--------|----------|-------------|-------|
| GET | / | All bookings | Admin, Manager |
| GET | /my-bookings | Client's bookings | Client |
| GET | /owner-bookings | Bookings for owner's cars | CarOwner |
| POST | / | Create booking | Client |
| PUT | /{id}/status | Update status | CarOwner, Admin |
| POST | /{id}/cancel | Cancel booking | Owner, Admin |

## Payments (/api/payments)
| Method | Endpoint | Description | Roles |
|--------|----------|-------------|-------|
| GET | /my-payments | Owner's payments | CarOwner |
| GET | /pending | Pending payments | CarOwner, Admin |
| PUT | /{id}/status | Confirm/Reject payment | CarOwner |

## Reports (/api/reports)
| Method | Endpoint | Description | Roles |
|--------|----------|-------------|-------|
| GET | /dashboard | Admin dashboard stats | Admin, Manager |
| GET | /owner-stats | Car owner statistics | CarOwner |
| GET | /client-stats | Client statistics | Client |

---

# 6. BUSINESS LOGIC & WORKFLOWS

## Car Listing Workflow
1. Car Owner (must have phone number) creates car listing
2. Car status = PendingApproval
3. **Email sent to Manager (tnkagimba@gmail.com)** for review
4. Manager approves â†’ Car status = Available
5. Car appears in public listings

## Booking Workflow
1. Client selects car and dates
2. System checks availability (no date conflicts)
3. Booking created with status = Pending
4. Payment record created with status = Pending
5. Car Owner notified of new booking
6. Car Owner confirms payment â†’ Booking = Confirmed
7. **Email sent to Client with Owner's contact info**
8. On pickup date â†’ Status = InProgress
9. On return â†’ Status = Completed

## Payment Processing (5% Commission)
```
Total Payment: $1000
â”œâ”€â”€ Platform Fee (5%): $50
â””â”€â”€ Owner Payout: $950
```

## User Registration Verification
1. User fills registration form
2. 6-digit code generated and saved to LoginVerificationTokens
3. Code sent via email with professional template
4. User enters code â†’ IsEmailVerified = true
5. JWT token returned â†’ User logged in

---

# 7. EMAIL NOTIFICATION SYSTEM

## Email Types

| Email | Trigger | Recipient | Template |
|-------|---------|-----------|----------|
| CEO Welcome | Registration/Google signup | New user | Branded HTML |
| Verification Code | Registration | New user | 6-digit code |
| Payment Confirmation | Payment confirmed | Client | Receipt |
| Owner Contact Info | Payment confirmed | Client | Owner phone/email |
| New Car Notification | Car listed | Manager | Review request |
| Password Reset | Forgot password | User | Reset link |

## Email Configuration
```json
{
  "EmailSettings": {
    "SmtpServer": "smtp.gmail.com",
    "SmtpPort": 587,
    "SenderEmail": "theophilentiganzwa@gmail.com",
    "SenderName": "Ntiganzwa Kagimba - CEO, Kigali Rental",
    "Password": "[App Password]"
  }
}
```

## Sample Verification Code Email
```html
ğŸ” Your Login Verification Code

Hello [FirstName],

Your verification code is:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   123456   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

This code will expire in 5 minutes.

âš ï¸ If you didn't try to register, please ignore this email.
```

---

# 8. SECURITY FEATURES

## Authentication
- JWT Bearer tokens (expires in 7 days)
- BCrypt password hashing
- Google OAuth 2.0 integration

## Authorization
- Role-based access control (RBAC)
- [Authorize(Roles = "...")] on endpoints
- User can only access own resources

## Email Verification
- 6-digit code with 5-minute expiry
- Codes invalidated after use
- Old codes invalidated when new code requested

## Data Protection
- Users can only modify own data
- Car Owners can only modify own cars
- Payments can only be confirmed by car owner
- Admins can force delete users (cascade delete)

---

# 9. TEST USERS & DEMO DATA

## Default Users

| Email | Password | Role |
|-------|----------|------|
| admin@kigalidrive.com | Admin123! | Admin |
| manager@kigalidrive.com | Manager123! | Manager |

## Creating Test Data

1. **Create Car Owner**:
   - POST /api/auth/register
   - Body: { firstName, lastName, email, password, role: 3 }
   - Verify with 6-digit code

2. **Create Client**:
   - POST /api/auth/register
   - Body: { firstName, lastName, email, password, role: 4 }
   - Verify with 6-digit code

3. **List a Car** (as Car Owner with phone number):
   - POST /api/cars
   - Body: { make, model, year, licensePlate, pricePerDay, ... }

4. **Approve Car** (as Manager):
   - POST /api/cars/{id}/approve
   - Body: { status: 2 }

5. **Book Car** (as Client):
   - POST /api/bookings
   - Body: { carId, startDate, endDate }

6. **Confirm Payment** (as Car Owner):
   - PUT /api/payments/{id}/status
   - Body: { status: 2, paymentMethod: "Cash" }

---

# 10. DOCKER DEPLOYMENT

## Overview
KigaliDrive is fully containerized using Docker, enabling deployment on any platform (Windows, macOS, Linux, Cloud).

## Docker Files

| File | Purpose |
|------|---------|
| Dockerfile | Backend .NET 8 multi-stage build |
| kigalidrive-frontend/Dockerfile | Frontend React + Nginx |
| docker-compose.yml | Service orchestration |
| nginx.conf | Nginx configuration with API proxy |
| .env.example | Environment variables template |

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Docker Host                    â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Frontend   â”‚       â”‚     Backend      â”‚    â”‚
â”‚  â”‚  (Nginx:80)  â”‚â”€â”€â”€â”€â”€â”€>â”‚  (.NET:5139)     â”‚    â”‚
â”‚  â”‚              â”‚  API  â”‚                  â”‚    â”‚
â”‚  â”‚  Port: 3000  â”‚       â”‚  Port: 5139      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                  â”‚              â”‚
â”‚                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                         â”‚  SQLite Volume   â”‚    â”‚
â”‚                         â”‚  (Persistent)    â”‚    â”‚
â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Quick Start Commands

```bash
# 1. Set up environment
cp .env.example .env
# Edit .env with your secrets

# 2. Build and run
docker-compose up --build -d

# 3. Access the application
# Frontend: http://localhost:3000
# API: http://localhost:5139/api
# Health: http://localhost:5139/api/health

# 4. View logs
docker-compose logs -f

# 5. Stop services
docker-compose down
```

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| JWT_SECRET_KEY | Yes | JWT signing key (min 32 characters) |
| EMAIL_PASSWORD | Yes | Gmail App Password for SMTP |
| GOOGLE_CLIENT_ID | No | Google OAuth Client ID |
| EMAIL_SENDER | No | Sender email address |

## Docker Compose Services

```yaml
services:
  backend:
    image: kigalidrive-api
    ports: 5139:5139
    volumes: kigalidrive-data:/app/Data
    
  frontend:
    image: kigalidrive-web
    ports: 3000:80
    depends_on: backend
```

## Production Considerations
- Use reverse proxy (Traefik, Nginx) for HTTPS
- Enable SSL/TLS certificates (Let's Encrypt)
- Use Docker Swarm or Kubernetes for scaling
- Configure proper logging and monitoring
- Set up automated backups for SQLite database

---

# CONCLUSION

KigaliDrive demonstrates a production-ready car rental platform with:
- Multi-tenant role-based architecture
- Secure authentication with email verification
- Complete booking and payment lifecycle
- Professional email notifications
- Real-time in-app notifications
- Comprehensive admin dashboard
- **Cross-platform Docker deployment**

The platform is built with modern technologies and follows best practices for security, scalability, and maintainability.

## Technology Summary
| Component | Technology |
|-----------|------------|
| Backend | .NET 8 Web API |
| Frontend | React 18 + Redux |
| Database | SQLite + EF Core |
| Auth | JWT + BCrypt + Google OAuth |
| Email | Gmail SMTP |
| Container | Docker + Docker Compose |
| Web Server | Nginx |
